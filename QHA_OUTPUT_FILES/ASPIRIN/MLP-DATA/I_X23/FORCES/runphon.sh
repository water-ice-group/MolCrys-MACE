#!/bin/bash
#SBATCH --account=MICHAELIDES-SL2-GPU
#SBATCH --output=slurm.out
#SBATCH --partition=ampere
#SBATCH --job-name=runphon
#SBATCH --time=00:15:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --gres=gpu:1

# Load libraries
. /etc/profile.d/modules.sh
module purge
module load rhel8/default-amp

# Python
source /rds/user/fd385/hpc-work/software/mace-venv/bin/activate
#source ~/.bashrc
#conda activate mace_env
#path=/home/cs-dell1/software-conda/mace/mace/cli


which python 

rm -rf FORCES 
header=$(head -n 1 POSCAR)
cp SPOSCAR POSCAR.phon

for i in \
 "   1  0.00087441  0.00000000  0.00000000 " \
 "   1 -0.00000000  0.00075834  0.00000000 " \
 "   1  0.00000000 -0.00000000  0.00088330 " \
 "   9  0.00087441  0.00000000  0.00000000 " \
 "   9 -0.00000000  0.00075834  0.00000000 " \
 "   9  0.00000000 -0.00000000  0.00088330 " \
 "  17  0.00087441  0.00000000  0.00000000 " \
 "  17 -0.00000000  0.00075834  0.00000000 " \
 "  17  0.00000000 -0.00000000  0.00088330 " \
 "  25  0.00087441  0.00000000  0.00000000 " \
 "  25 -0.00000000  0.00075834  0.00000000 " \
 "  25  0.00000000 -0.00000000  0.00088330 " \
 "  33  0.00087441  0.00000000  0.00000000 " \
 "  33 -0.00000000  0.00075834  0.00000000 " \
 "  33  0.00000000 -0.00000000  0.00088330 " \
 "  41  0.00087441  0.00000000  0.00000000 " \
 "  41 -0.00000000  0.00075834  0.00000000 " \
 "  41  0.00000000 -0.00000000  0.00088330 " \
 "  49  0.00087441  0.00000000  0.00000000 " \
 "  49 -0.00000000  0.00075834  0.00000000 " \
 "  49  0.00000000 -0.00000000  0.00088330 " \
 "  57  0.00087441  0.00000000  0.00000000 " \
 "  57 -0.00000000  0.00075834  0.00000000 " \
 "  57  0.00000000 -0.00000000  0.00088330 " \
 "  65  0.00087441  0.00000000  0.00000000 " \
 "  65 -0.00000000  0.00075834  0.00000000 " \
 "  65  0.00000000 -0.00000000  0.00088330 " \
 "  73  0.00087441  0.00000000  0.00000000 " \
 "  73 -0.00000000  0.00075834  0.00000000 " \
 "  73  0.00000000 -0.00000000  0.00088330 " \
 "  81  0.00087441  0.00000000  0.00000000 " \
 "  81 -0.00000000  0.00075834  0.00000000 " \
 "  81  0.00000000 -0.00000000  0.00088330 " \
 "  89  0.00087441  0.00000000  0.00000000 " \
 "  89 -0.00000000  0.00075834  0.00000000 " \
 "  89  0.00000000 -0.00000000  0.00088330 " \
 "  97  0.00087441  0.00000000  0.00000000 " \
 "  97 -0.00000000  0.00075834  0.00000000 " \
 "  97  0.00000000 -0.00000000  0.00088330 " \
 " 105  0.00087441  0.00000000  0.00000000 " \
 " 105 -0.00000000  0.00075834  0.00000000 " \
 " 105  0.00000000 -0.00000000  0.00088330 " \
 " 113  0.00087441  0.00000000  0.00000000 " \
 " 113 -0.00000000  0.00075834  0.00000000 " \
 " 113  0.00000000 -0.00000000  0.00088330 " \
 " 121  0.00087441  0.00000000  0.00000000 " \
 " 121 -0.00000000  0.00075834  0.00000000 " \
 " 121  0.00000000 -0.00000000  0.00088330 " \
 " 129  0.00087441  0.00000000  0.00000000 " \
 " 129 -0.00000000  0.00075834  0.00000000 " \
 " 129  0.00000000 -0.00000000  0.00088330 " \
 " 137  0.00087441  0.00000000  0.00000000 " \
 " 137 -0.00000000  0.00075834  0.00000000 " \
 " 137  0.00000000 -0.00000000  0.00088330 " \
 " 145  0.00087441  0.00000000  0.00000000 " \
 " 145 -0.00000000  0.00075834  0.00000000 " \
 " 145  0.00000000 -0.00000000  0.00088330 " \
 " 153  0.00087441  0.00000000  0.00000000 " \
 " 153 -0.00000000  0.00075834  0.00000000 " \
 " 153  0.00000000 -0.00000000  0.00088330 " \
 " 161  0.00087441  0.00000000  0.00000000 " \
 " 161 -0.00000000  0.00075834  0.00000000 " \
 " 161  0.00000000 -0.00000000  0.00088330 " \
 "   1 -0.00087441  0.00000000  0.00000000 " \
 "   1  0.00000000 -0.00075834  0.00000000 " \
 "   1  0.00000000  0.00000000 -0.00088330 " \
 "   9 -0.00087441  0.00000000  0.00000000 " \
 "   9  0.00000000 -0.00075834  0.00000000 " \
 "   9  0.00000000  0.00000000 -0.00088330 " \
 "  17 -0.00087441  0.00000000  0.00000000 " \
 "  17  0.00000000 -0.00075834  0.00000000 " \
 "  17  0.00000000  0.00000000 -0.00088330 " \
 "  25 -0.00087441  0.00000000  0.00000000 " \
 "  25  0.00000000 -0.00075834  0.00000000 " \
 "  25  0.00000000  0.00000000 -0.00088330 " \
 "  33 -0.00087441  0.00000000  0.00000000 " \
 "  33  0.00000000 -0.00075834  0.00000000 " \
 "  33  0.00000000  0.00000000 -0.00088330 " \
 "  41 -0.00087441  0.00000000  0.00000000 " \
 "  41  0.00000000 -0.00075834  0.00000000 " \
 "  41  0.00000000  0.00000000 -0.00088330 " \
 "  49 -0.00087441  0.00000000  0.00000000 " \
 "  49  0.00000000 -0.00075834  0.00000000 " \
 "  49  0.00000000  0.00000000 -0.00088330 " \
 "  57 -0.00087441  0.00000000  0.00000000 " \
 "  57  0.00000000 -0.00075834  0.00000000 " \
 "  57  0.00000000  0.00000000 -0.00088330 " \
 "  65 -0.00087441  0.00000000  0.00000000 " \
 "  65  0.00000000 -0.00075834  0.00000000 " \
 "  65  0.00000000  0.00000000 -0.00088330 " \
 "  73 -0.00087441  0.00000000  0.00000000 " \
 "  73  0.00000000 -0.00075834  0.00000000 " \
 "  73  0.00000000  0.00000000 -0.00088330 " \
 "  81 -0.00087441  0.00000000  0.00000000 " \
 "  81  0.00000000 -0.00075834  0.00000000 " \
 "  81  0.00000000  0.00000000 -0.00088330 " \
 "  89 -0.00087441  0.00000000  0.00000000 " \
 "  89  0.00000000 -0.00075834  0.00000000 " \
 "  89  0.00000000  0.00000000 -0.00088330 " \
 "  97 -0.00087441  0.00000000  0.00000000 " \
 "  97  0.00000000 -0.00075834  0.00000000 " \
 "  97  0.00000000  0.00000000 -0.00088330 " \
 " 105 -0.00087441  0.00000000  0.00000000 " \
 " 105  0.00000000 -0.00075834  0.00000000 " \
 " 105  0.00000000  0.00000000 -0.00088330 " \
 " 113 -0.00087441  0.00000000  0.00000000 " \
 " 113  0.00000000 -0.00075834  0.00000000 " \
 " 113  0.00000000  0.00000000 -0.00088330 " \
 " 121 -0.00087441  0.00000000  0.00000000 " \
 " 121  0.00000000 -0.00075834  0.00000000 " \
 " 121  0.00000000  0.00000000 -0.00088330 " \
 " 129 -0.00087441  0.00000000  0.00000000 " \
 " 129  0.00000000 -0.00075834  0.00000000 " \
 " 129  0.00000000  0.00000000 -0.00088330 " \
 " 137 -0.00087441  0.00000000  0.00000000 " \
 " 137  0.00000000 -0.00075834  0.00000000 " \
 " 137  0.00000000  0.00000000 -0.00088330 " \
 " 145 -0.00087441  0.00000000  0.00000000 " \
 " 145  0.00000000 -0.00075834  0.00000000 " \
 " 145  0.00000000  0.00000000 -0.00088330 " \
 " 153 -0.00087441  0.00000000  0.00000000 " \
 " 153  0.00000000 -0.00075834  0.00000000 " \
 " 153  0.00000000  0.00000000 -0.00088330 " \
 " 161 -0.00087441  0.00000000  0.00000000 " \
 " 161  0.00000000 -0.00075834  0.00000000 " \
 " 161  0.00000000  0.00000000 -0.00088330 "
do

awk '
/SUBSIT/  { npos = $2 ; 
            x=$3; y=$4 ; z=$5; }
!/SUBSIT/ { line=line+1 
  if (line-7 == npos) {
    printf "%12.9f %12.9f %12.9f\n", $1+x, $2+y, $3+z
  } 
  else if (line > 7) {
    printf "%12.9f %12.9f %12.9f\n", $1, $2, $3
  } 
  else 
    print 
} ' >POSCAR.phon <<!
SUBSIT $i
`cat SPOSCAR`
!


sed -i '5s/$/\n'"$header"'/' POSCAR.phon

python run-phon.py  $i
rm -f POSCAR.phon

done


Ndisp=`wc -l DISP | awk '{print $1}'`
sed -i "1s/^/$Ndisp\n/" FORCES
