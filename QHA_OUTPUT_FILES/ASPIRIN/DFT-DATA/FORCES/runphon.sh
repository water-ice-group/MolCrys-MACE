#!/bin/bash

#SBATCH --job-name=iPI-MD
#SBATCH --nodes=2
#SBATCH --tasks-per-node=128
#SBATCH --cpus-per-task=1
#SBATCH --time=24:00:00

# Replace [budget code] below with your project code (e.g. t01)
#SBATCH --account=e865
#SBATCH --partition=standard
#SBATCH --qos=standard



# Avoid any unintentional OpenMP threading by setting OMP_NUM_THREADS
export OMP_NUM_THREADS=1

# Load the VASP module
module load vasp/6/6.4.1-vtst

# Avoid any unintentional OpenMP threading by setting OMP_NUM_THREADS
export OMP_NUM_THREADS=1


#loading python
module load cray-python


#################################################################################

# Load ASE
export PYTHONUSERBASE=/work/e865/e865/fdellapia1/.local
export PATH=$PYTHONUSERBASE/bin:$PATH
export PYTHONPATH=$PYTHONUSERBASE/lib/python3.9/site-packages:$PYTHONPATH


ase=/work/e865/e865/fdellapia1/.local/bin/ase

#################################################################################

header=$(head -n 1 POSCAR_START)
cp SPOSCAR POSCAR

if test -f POSCAR.phon 
then 
  echo "POSCAR.phon exist remove before starting batchfile"
  exit 1
fi
cp POSCAR POSCAR.phon 
#
#  loop over all exited ions
#
j=0
# here put the content of the DISP file
for i in \
 "   1  0.00087441  0.00000000  0.00000000 " \
 "   1 -0.00000000  0.00075834  0.00000000 " \
 "   1  0.00000000 -0.00000000  0.00088330 " \
 "   9  0.00087441  0.00000000  0.00000000 " \
 "   9 -0.00000000  0.00075834  0.00000000 " \
 "   9  0.00000000 -0.00000000  0.00088330 " \
 "  17  0.00087441  0.00000000  0.00000000 " \
 "  17 -0.00000000  0.00075834  0.00000000 " \
 "  17  0.00000000 -0.00000000  0.00088330 " \
 "  25  0.00087441  0.00000000  0.00000000 " \
 "  25 -0.00000000  0.00075834  0.00000000 " \
 "  25  0.00000000 -0.00000000  0.00088330 " \
 "  33  0.00087441  0.00000000  0.00000000 " \
 "  33 -0.00000000  0.00075834  0.00000000 " \
 "  33  0.00000000 -0.00000000  0.00088330 " \
 "  41  0.00087441  0.00000000  0.00000000 " \
 "  41 -0.00000000  0.00075834  0.00000000 " \
 "  41  0.00000000 -0.00000000  0.00088330 " \
 "  49  0.00087441  0.00000000  0.00000000 " \
 "  49 -0.00000000  0.00075834  0.00000000 " \
 "  49  0.00000000 -0.00000000  0.00088330 " \
 "  57  0.00087441  0.00000000  0.00000000 " \
 "  57 -0.00000000  0.00075834  0.00000000 " \
 "  57  0.00000000 -0.00000000  0.00088330 " \
 "  65  0.00087441  0.00000000  0.00000000 " \
 "  65 -0.00000000  0.00075834  0.00000000 " \
 "  65  0.00000000 -0.00000000  0.00088330 " \
 "  73  0.00087441  0.00000000  0.00000000 " \
 "  73 -0.00000000  0.00075834  0.00000000 " \
 "  73  0.00000000 -0.00000000  0.00088330 " \
 "  81  0.00087441  0.00000000  0.00000000 " \
 "  81 -0.00000000  0.00075834  0.00000000 " \
 "  81  0.00000000 -0.00000000  0.00088330 " \
 "  89  0.00087441  0.00000000  0.00000000 " \
 "  89 -0.00000000  0.00075834  0.00000000 " \
 "  89  0.00000000 -0.00000000  0.00088330 " \
 "  97  0.00087441  0.00000000  0.00000000 " \
 "  97 -0.00000000  0.00075834  0.00000000 " \
 "  97  0.00000000 -0.00000000  0.00088330 " \
 " 105  0.00087441  0.00000000  0.00000000 " \
 " 105 -0.00000000  0.00075834  0.00000000 " \
 " 105  0.00000000 -0.00000000  0.00088330 " \
 " 113  0.00087441  0.00000000  0.00000000 " \
 " 113 -0.00000000  0.00075834  0.00000000 " \
 " 113  0.00000000 -0.00000000  0.00088330 " \
 " 121  0.00087441  0.00000000  0.00000000 " \
 " 121 -0.00000000  0.00075834  0.00000000 " \
 " 121  0.00000000 -0.00000000  0.00088330 " \
 " 129  0.00087441  0.00000000  0.00000000 " \
 " 129 -0.00000000  0.00075834  0.00000000 " \
 " 129  0.00000000 -0.00000000  0.00088330 " \
 " 137  0.00087441  0.00000000  0.00000000 " \
 " 137 -0.00000000  0.00075834  0.00000000 " \
 " 137  0.00000000 -0.00000000  0.00088330 " \
 " 145  0.00087441  0.00000000  0.00000000 " \
 " 145 -0.00000000  0.00075834  0.00000000 " \
 " 145  0.00000000 -0.00000000  0.00088330 " \
 " 153  0.00087441  0.00000000  0.00000000 " \
 " 153 -0.00000000  0.00075834  0.00000000 " \
 " 153  0.00000000 -0.00000000  0.00088330 " \
 " 161  0.00087441  0.00000000  0.00000000 " \
 " 161 -0.00000000  0.00075834  0.00000000 " \
 " 161  0.00000000 -0.00000000  0.00088330 " \
 "   1 -0.00087441 -0.00000000 -0.00000000 " \
 "   1  0.00000000 -0.00075834 -0.00000000 " \
 "   1 -0.00000000  0.00000000 -0.00088330 " \
 "   9 -0.00087441 -0.00000000 -0.00000000 " \
 "   9  0.00000000 -0.00075834 -0.00000000 " \
 "   9 -0.00000000  0.00000000 -0.00088330 " \
 "  17 -0.00087441 -0.00000000 -0.00000000 " \
 "  17  0.00000000 -0.00075834 -0.00000000 " \
 "  17 -0.00000000  0.00000000 -0.00088330 " \
 "  25 -0.00087441 -0.00000000 -0.00000000 " \
 "  25  0.00000000 -0.00075834 -0.00000000 " \
 "  25 -0.00000000  0.00000000 -0.00088330 " \
 "  33 -0.00087441 -0.00000000 -0.00000000 " \
 "  33  0.00000000 -0.00075834 -0.00000000 " \
 "  33 -0.00000000  0.00000000 -0.00088330 " \
 "  41 -0.00087441 -0.00000000 -0.00000000 " \
 "  41  0.00000000 -0.00075834 -0.00000000 " \
 "  41 -0.00000000  0.00000000 -0.00088330 " \
 "  49 -0.00087441 -0.00000000 -0.00000000 " \
 "  49  0.00000000 -0.00075834 -0.00000000 " \
 "  49 -0.00000000  0.00000000 -0.00088330 " \
 "  57 -0.00087441 -0.00000000 -0.00000000 " \
 "  57  0.00000000 -0.00075834 -0.00000000 " \
 "  57 -0.00000000  0.00000000 -0.00088330 " \
 "  65 -0.00087441 -0.00000000 -0.00000000 " \
 "  65  0.00000000 -0.00075834 -0.00000000 " \
 "  65 -0.00000000  0.00000000 -0.00088330 " \
 "  73 -0.00087441 -0.00000000 -0.00000000 " \
 "  73  0.00000000 -0.00075834 -0.00000000 " \
 "  73 -0.00000000  0.00000000 -0.00088330 " \
 "  81 -0.00087441 -0.00000000 -0.00000000 " \
 "  81  0.00000000 -0.00075834 -0.00000000 " \
 "  81 -0.00000000  0.00000000 -0.00088330 " \
 "  89 -0.00087441 -0.00000000 -0.00000000 " \
 "  89  0.00000000 -0.00075834 -0.00000000 " \
 "  89 -0.00000000  0.00000000 -0.00088330 " \
 "  97 -0.00087441 -0.00000000 -0.00000000 " \
 "  97  0.00000000 -0.00075834 -0.00000000 " \
 "  97 -0.00000000  0.00000000 -0.00088330 " \
 " 105 -0.00087441 -0.00000000 -0.00000000 " \
 " 105  0.00000000 -0.00075834 -0.00000000 " \
 " 105 -0.00000000  0.00000000 -0.00088330 " \
 " 113 -0.00087441 -0.00000000 -0.00000000 " \
 " 113  0.00000000 -0.00075834 -0.00000000 " \
 " 113 -0.00000000  0.00000000 -0.00088330 " \
 " 121 -0.00087441 -0.00000000 -0.00000000 " \
 " 121  0.00000000 -0.00075834 -0.00000000 " \
 " 121 -0.00000000  0.00000000 -0.00088330 " \
 " 129 -0.00087441 -0.00000000 -0.00000000 " \
 " 129  0.00000000 -0.00075834 -0.00000000 " \
 " 129 -0.00000000  0.00000000 -0.00088330 " \
 " 137 -0.00087441 -0.00000000 -0.00000000 " \
 " 137  0.00000000 -0.00075834 -0.00000000 " \
 " 137 -0.00000000  0.00000000 -0.00088330 " \
 " 145 -0.00087441 -0.00000000 -0.00000000 " \
 " 145  0.00000000 -0.00075834 -0.00000000 " \
 " 145 -0.00000000  0.00000000 -0.00088330 " \
 " 153 -0.00087441 -0.00000000 -0.00000000 " \
 " 153  0.00000000 -0.00075834 -0.00000000 " \
 " 153 -0.00000000  0.00000000 -0.00088330 " \
 " 161 -0.00087441 -0.00000000 -0.00000000 " \
 " 161  0.00000000 -0.00075834 -0.00000000 " \
 " 161 -0.00000000  0.00000000 -0.00088330 "
do
j=`expr $j + 1`
echo "run number $j"

#
# use awk to displace atoms (somewhat tricky)
#
awk '
/SUBSIT/  { npos = $2 ; 
            x=$3; y=$4 ; z=$5; }
!/SUBSIT/ { line=line+1 
  if (line-7 == npos) {
    printf "%12.9f %12.9f %12.9f\n", $1+x, $2+y, $3+z
  } 
  else if (line > 7) {
    printf "%12.9f %12.9f %12.9f\n", $1, $2, $3
  } 
  else 
    print 
} ' >POSCAR <<!
SUBSIT $i
`cat POSCAR.phon`
!

#########################################################################################################

if test ! -f out_${j}.extxyz
then
# here the call to PWSCF

# Load the VASP module
srun --distribution=block:block --hint=nomultithread vasp_gam


$ase convert OUTCAR out_${j}.extxyz
cp OUTCAR OUTCAR.${j}
fi
#
# use awk to extract forces 
#
#
echo $i >DYNMAT.$j
cat out_${j}.extxyz | awk '{if ( NR>2) printf "%14.8f  %14.8f  %14.8f\n",$5,$6,$7  }' >>DYNMAT.$j
done

# restore POSCAR file
mv POSCAR.phon POSCAR

echo $j > FORCES
i=1
while test $i -le $j
do 
cat DYNMAT.$i >> FORCES
i=`expr $i + 1`
done

cp POSCAR_START POSCAR

