#!/bin/bash -l
#SBATCH --job-name="mace_md"
#SBATCH --account="s1288"
#SBATCH --time=04:30:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-core=1
#SBATCH --ntasks-per-node=12
#SBATCH --cpus-per-task=1
#SBATCH --partition=normal
#SBATCH --constraint=gpu
#SBATCH --hint=nomultithread

export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
export CRAY_CUDA_MPS=1

module load daint-gpu


source /users/fdellapi/software/mace-venv/bin/activate



which python 

rm -rf FORCES 
header=$(head -n 1 POSCAR)
cp SPOSCAR POSCAR.phon

for i in \
 "   1  0.00102391  0.00000000  0.00000000 " \ "   1 -0.00000000  0.00102391  0.00000000 " \ "   1 -0.00000000 -0.00000000  0.00036124 " \ "   5  0.00102391  0.00000000  0.00000000 " \ "   5 -0.00000000  0.00102391  0.00000000 " \ "   5 -0.00000000 -0.00000000  0.00036124 " \ "   9  0.00102391  0.00000000  0.00000000 " \ "   9 -0.00000000  0.00102391  0.00000000 " \ "   9 -0.00000000 -0.00000000  0.00036124 " \ "  13  0.00102391  0.00000000  0.00000000 " \ "  13 -0.00000000  0.00102391  0.00000000 " \ "  13 -0.00000000 -0.00000000  0.00036124 " \ "  17  0.00102391  0.00000000  0.00000000 " \ "  17 -0.00000000  0.00102391  0.00000000 " \ "  17 -0.00000000 -0.00000000  0.00036124 " \ "  21  0.00102391  0.00000000  0.00000000 " \ "  21 -0.00000000  0.00102391  0.00000000 " \ "  21 -0.00000000 -0.00000000  0.00036124 " \ "  25  0.00102391  0.00000000  0.00000000 " \ "  25 -0.00000000  0.00102391  0.00000000 " \ "  25 -0.00000000 -0.00000000  0.00036124 " \ "  29  0.00102391  0.00000000  0.00000000 " \ "  29 -0.00000000  0.00102391  0.00000000 " \ "  29 -0.00000000 -0.00000000  0.00036124 " \ "  33  0.00102391  0.00000000  0.00000000 " \ "  33 -0.00000000  0.00102391  0.00000000 " \ "  33 -0.00000000 -0.00000000  0.00036124 " \ "  37  0.00102391  0.00000000  0.00000000 " \ "  37 -0.00000000  0.00102391  0.00000000 " \ "  37 -0.00000000 -0.00000000  0.00036124 " \ "  41  0.00102391  0.00000000  0.00000000 " \ "  41 -0.00000000  0.00102391  0.00000000 " \ "  41 -0.00000000 -0.00000000  0.00036124 " \ "  45  0.00102391  0.00000000  0.00000000 " \ "  45 -0.00000000  0.00102391  0.00000000 " \ "  45 -0.00000000 -0.00000000  0.00036124 " \ "  49  0.00102391  0.00000000  0.00000000 " \ "  49 -0.00000000  0.00102391  0.00000000 " \ "  49 -0.00000000 -0.00000000  0.00036124 " \ "  53  0.00102391  0.00000000  0.00000000 " \ "  53 -0.00000000  0.00102391  0.00000000 " \ "  53 -0.00000000 -0.00000000  0.00036124 " \ "  57  0.00102391  0.00000000  0.00000000 " \ "  57 -0.00000000  0.00102391  0.00000000 " \ "  57 -0.00000000 -0.00000000  0.00036124 " \ "  61  0.00102391  0.00000000  0.00000000 " \ "  61 -0.00000000  0.00102391  0.00000000 " \ "  61 -0.00000000 -0.00000000  0.00036124 " \ "  65  0.00102391  0.00000000  0.00000000 " \ "  65 -0.00000000  0.00102391  0.00000000 " \ "  65 -0.00000000 -0.00000000  0.00036124 " \ "  69  0.00102391  0.00000000  0.00000000 " \ "  69 -0.00000000  0.00102391  0.00000000 " \ "  69 -0.00000000 -0.00000000  0.00036124 " \ "  73  0.00102391  0.00000000  0.00000000 " \ "  73 -0.00000000  0.00102391  0.00000000 " \ "  73 -0.00000000 -0.00000000  0.00036124 " \ "  77  0.00102391  0.00000000  0.00000000 " \ "  77 -0.00000000  0.00102391  0.00000000 " \ "  77 -0.00000000 -0.00000000  0.00036124 " \ "  81  0.00102391  0.00000000  0.00000000 " \ "  81 -0.00000000  0.00102391  0.00000000 " \ "  81 -0.00000000 -0.00000000  0.00036124 " \ "  85  0.00102391  0.00000000  0.00000000 " \ "  85 -0.00000000  0.00102391  0.00000000 " \ "  85 -0.00000000 -0.00000000  0.00036124 " \ "  89  0.00102391  0.00000000  0.00000000 " \ "  89 -0.00000000  0.00102391  0.00000000 " \ "  89 -0.00000000 -0.00000000  0.00036124 " \ "  93  0.00102391  0.00000000  0.00000000 " \ "  93 -0.00000000  0.00102391  0.00000000 " \ "  93 -0.00000000 -0.00000000  0.00036124 " \ "  97  0.00102391  0.00000000  0.00000000 " \ "  97 -0.00000000  0.00102391  0.00000000 " \ "  97 -0.00000000 -0.00000000  0.00036124 " \ " 101  0.00102391  0.00000000  0.00000000 " \ " 101 -0.00000000  0.00102391  0.00000000 " \ " 101 -0.00000000 -0.00000000  0.00036124 " \ " 105  0.00102391  0.00000000  0.00000000 " \ " 105 -0.00000000  0.00102391  0.00000000 " \ " 105 -0.00000000 -0.00000000  0.00036124 " \ " 109  0.00102391  0.00000000  0.00000000 " \ " 109 -0.00000000  0.00102391  0.00000000 " \ " 109 -0.00000000 -0.00000000  0.00036124 " \ " 113  0.00102391  0.00000000  0.00000000 " \ " 113 -0.00000000  0.00102391  0.00000000 " \ " 113 -0.00000000 -0.00000000  0.00036124 " \ " 117  0.00102391  0.00000000  0.00000000 " \ " 117 -0.00000000  0.00102391  0.00000000 " \ " 117 -0.00000000 -0.00000000  0.00036124 " \ " 121  0.00102391  0.00000000  0.00000000 " \ " 121 -0.00000000  0.00102391  0.00000000 " \ " 121 -0.00000000 -0.00000000  0.00036124 " \ " 125  0.00102391  0.00000000  0.00000000 " \ " 125 -0.00000000  0.00102391  0.00000000 " \ " 125 -0.00000000 -0.00000000  0.00036124 " \ " 129  0.00102391  0.00000000  0.00000000 " \ " 129 -0.00000000  0.00102391  0.00000000 " \ " 129 -0.00000000 -0.00000000  0.00036124 " \ " 133  0.00102391  0.00000000  0.00000000 " \ " 133 -0.00000000  0.00102391  0.00000000 " \ " 133 -0.00000000 -0.00000000  0.00036124 " \ " 137  0.00102391  0.00000000  0.00000000 " \ " 137 -0.00000000  0.00102391  0.00000000 " \ " 137 -0.00000000 -0.00000000  0.00036124 " \ " 141  0.00102391  0.00000000  0.00000000 " \ " 141 -0.00000000  0.00102391  0.00000000 " \ " 141 -0.00000000 -0.00000000  0.00036124 " \ " 145  0.00102391  0.00000000  0.00000000 " \ " 145 -0.00000000  0.00102391  0.00000000 " \ " 145 -0.00000000 -0.00000000  0.00036124 " \ " 149  0.00102391  0.00000000  0.00000000 " \ " 149 -0.00000000  0.00102391  0.00000000 " \ " 149 -0.00000000 -0.00000000  0.00036124 " \ " 153  0.00102391  0.00000000  0.00000000 " \ " 153 -0.00000000  0.00102391  0.00000000 " \ " 153 -0.00000000 -0.00000000  0.00036124 " \ " 157  0.00102391  0.00000000  0.00000000 " \ " 157 -0.00000000  0.00102391  0.00000000 " \ " 157 -0.00000000 -0.00000000  0.00036124 " \ " 161  0.00102391  0.00000000  0.00000000 " \ " 161 -0.00000000  0.00102391  0.00000000 " \ " 161 -0.00000000 -0.00000000  0.00036124 " \ " 165  0.00102391  0.00000000  0.00000000 " \ " 165 -0.00000000  0.00102391  0.00000000 " \ " 165 -0.00000000 -0.00000000  0.00036124 " \ " 169  0.00102391  0.00000000  0.00000000 " \ " 169 -0.00000000  0.00102391  0.00000000 " \ " 169 -0.00000000 -0.00000000  0.00036124 " \ " 173  0.00102391  0.00000000  0.00000000 " \ " 173 -0.00000000  0.00102391  0.00000000 " \ " 173 -0.00000000 -0.00000000  0.00036124 " \ " 177  0.00102391  0.00000000  0.00000000 " \ " 177 -0.00000000  0.00102391  0.00000000 " \ " 177 -0.00000000 -0.00000000  0.00036124 " \ " 181  0.00102391  0.00000000  0.00000000 " \ " 181 -0.00000000  0.00102391  0.00000000 " \ " 181 -0.00000000 -0.00000000  0.00036124 " \ " 185  0.00102391  0.00000000  0.00000000 " \ " 185 -0.00000000  0.00102391  0.00000000 " \ " 185 -0.00000000 -0.00000000  0.00036124 " \ " 189  0.00102391  0.00000000  0.00000000 " \ " 189 -0.00000000  0.00102391  0.00000000 " \ " 189 -0.00000000 -0.00000000  0.00036124 " \ " 193  0.00102391  0.00000000  0.00000000 " \ " 193 -0.00000000  0.00102391  0.00000000 " \ " 193 -0.00000000 -0.00000000  0.00036124 " \ " 197  0.00102391  0.00000000  0.00000000 " \ " 197 -0.00000000  0.00102391  0.00000000 " \ " 197 -0.00000000 -0.00000000  0.00036124 " \ " 201  0.00102391  0.00000000  0.00000000 " \ " 201 -0.00000000  0.00102391  0.00000000 " \ " 201 -0.00000000 -0.00000000  0.00036124 " \ " 205  0.00102391  0.00000000  0.00000000 " \ " 205 -0.00000000  0.00102391  0.00000000 " \ " 205 -0.00000000 -0.00000000  0.00036124 " \ " 209  0.00102391  0.00000000  0.00000000 " \ " 209 -0.00000000  0.00102391  0.00000000 " \ " 209 -0.00000000 -0.00000000  0.00036124 " \ " 213  0.00102391  0.00000000  0.00000000 " \ " 213 -0.00000000  0.00102391  0.00000000 " \ " 213 -0.00000000 -0.00000000  0.00036124 " \ "   1 -0.00102391  0.00000000  0.00000000 " \ "   1  0.00000000 -0.00102391  0.00000000 " \ "   1  0.00000000  0.00000000 -0.00036124 " \ "   5 -0.00102391  0.00000000  0.00000000 " \ "   5  0.00000000 -0.00102391  0.00000000 " \ "   5  0.00000000  0.00000000 -0.00036124 " \ "   9 -0.00102391  0.00000000  0.00000000 " \ "   9  0.00000000 -0.00102391  0.00000000 " \ "   9  0.00000000  0.00000000 -0.00036124 " \ "  13 -0.00102391  0.00000000  0.00000000 " \ "  13  0.00000000 -0.00102391  0.00000000 " \ "  13  0.00000000  0.00000000 -0.00036124 " \ "  17 -0.00102391  0.00000000  0.00000000 " \ "  17  0.00000000 -0.00102391  0.00000000 " \ "  17  0.00000000  0.00000000 -0.00036124 " \ "  21 -0.00102391  0.00000000  0.00000000 " \ "  21  0.00000000 -0.00102391  0.00000000 " \ "  21  0.00000000  0.00000000 -0.00036124 " \ "  25 -0.00102391  0.00000000  0.00000000 " \ "  25  0.00000000 -0.00102391  0.00000000 " \ "  25  0.00000000  0.00000000 -0.00036124 " \ "  29 -0.00102391  0.00000000  0.00000000 " \ "  29  0.00000000 -0.00102391  0.00000000 " \ "  29  0.00000000  0.00000000 -0.00036124 " \ "  33 -0.00102391  0.00000000  0.00000000 " \ "  33  0.00000000 -0.00102391  0.00000000 " \ "  33  0.00000000  0.00000000 -0.00036124 " \ "  37 -0.00102391  0.00000000  0.00000000 " \ "  37  0.00000000 -0.00102391  0.00000000 " \ "  37  0.00000000  0.00000000 -0.00036124 " \ "  41 -0.00102391  0.00000000  0.00000000 " \ "  41  0.00000000 -0.00102391  0.00000000 " \ "  41  0.00000000  0.00000000 -0.00036124 " \ "  45 -0.00102391  0.00000000  0.00000000 " \ "  45  0.00000000 -0.00102391  0.00000000 " \ "  45  0.00000000  0.00000000 -0.00036124 " \ "  49 -0.00102391  0.00000000  0.00000000 " \ "  49  0.00000000 -0.00102391  0.00000000 " \ "  49  0.00000000  0.00000000 -0.00036124 " \ "  53 -0.00102391  0.00000000  0.00000000 " \ "  53  0.00000000 -0.00102391  0.00000000 " \ "  53  0.00000000  0.00000000 -0.00036124 " \ "  57 -0.00102391  0.00000000  0.00000000 " \ "  57  0.00000000 -0.00102391  0.00000000 " \ "  57  0.00000000  0.00000000 -0.00036124 " \ "  61 -0.00102391  0.00000000  0.00000000 " \ "  61  0.00000000 -0.00102391  0.00000000 " \ "  61  0.00000000  0.00000000 -0.00036124 " \ "  65 -0.00102391  0.00000000  0.00000000 " \ "  65  0.00000000 -0.00102391  0.00000000 " \ "  65  0.00000000  0.00000000 -0.00036124 " \ "  69 -0.00102391  0.00000000  0.00000000 " \ "  69  0.00000000 -0.00102391  0.00000000 " \ "  69  0.00000000  0.00000000 -0.00036124 " \ "  73 -0.00102391  0.00000000  0.00000000 " \ "  73  0.00000000 -0.00102391  0.00000000 " \ "  73  0.00000000  0.00000000 -0.00036124 " \ "  77 -0.00102391  0.00000000  0.00000000 " \ "  77  0.00000000 -0.00102391  0.00000000 " \ "  77  0.00000000  0.00000000 -0.00036124 " \ "  81 -0.00102391  0.00000000  0.00000000 " \ "  81  0.00000000 -0.00102391  0.00000000 " \ "  81  0.00000000  0.00000000 -0.00036124 " \ "  85 -0.00102391  0.00000000  0.00000000 " \ "  85  0.00000000 -0.00102391  0.00000000 " \ "  85  0.00000000  0.00000000 -0.00036124 " \ "  89 -0.00102391  0.00000000  0.00000000 " \ "  89  0.00000000 -0.00102391  0.00000000 " \ "  89  0.00000000  0.00000000 -0.00036124 " \ "  93 -0.00102391  0.00000000  0.00000000 " \ "  93  0.00000000 -0.00102391  0.00000000 " \ "  93  0.00000000  0.00000000 -0.00036124 " \ "  97 -0.00102391  0.00000000  0.00000000 " \ "  97  0.00000000 -0.00102391  0.00000000 " \ "  97  0.00000000  0.00000000 -0.00036124 " \ " 101 -0.00102391  0.00000000  0.00000000 " \ " 101  0.00000000 -0.00102391  0.00000000 " \ " 101  0.00000000  0.00000000 -0.00036124 " \ " 105 -0.00102391  0.00000000  0.00000000 " \ " 105  0.00000000 -0.00102391  0.00000000 " \ " 105  0.00000000  0.00000000 -0.00036124 " \ " 109 -0.00102391  0.00000000  0.00000000 " \ " 109  0.00000000 -0.00102391  0.00000000 " \ " 109  0.00000000  0.00000000 -0.00036124 " \ " 113 -0.00102391  0.00000000  0.00000000 " \ " 113  0.00000000 -0.00102391  0.00000000 " \ " 113  0.00000000  0.00000000 -0.00036124 " \ " 117 -0.00102391  0.00000000  0.00000000 " \ " 117  0.00000000 -0.00102391  0.00000000 " \ " 117  0.00000000  0.00000000 -0.00036124 " \ " 121 -0.00102391  0.00000000  0.00000000 " \ " 121  0.00000000 -0.00102391  0.00000000 " \ " 121  0.00000000  0.00000000 -0.00036124 " \ " 125 -0.00102391  0.00000000  0.00000000 " \ " 125  0.00000000 -0.00102391  0.00000000 " \ " 125  0.00000000  0.00000000 -0.00036124 " \ " 129 -0.00102391  0.00000000  0.00000000 " \ " 129  0.00000000 -0.00102391  0.00000000 " \ " 129  0.00000000  0.00000000 -0.00036124 " \ " 133 -0.00102391  0.00000000  0.00000000 " \ " 133  0.00000000 -0.00102391  0.00000000 " \ " 133  0.00000000  0.00000000 -0.00036124 " \ " 137 -0.00102391  0.00000000  0.00000000 " \ " 137  0.00000000 -0.00102391  0.00000000 " \ " 137  0.00000000  0.00000000 -0.00036124 " \ " 141 -0.00102391  0.00000000  0.00000000 " \ " 141  0.00000000 -0.00102391  0.00000000 " \ " 141  0.00000000  0.00000000 -0.00036124 " \ " 145 -0.00102391  0.00000000  0.00000000 " \ " 145  0.00000000 -0.00102391  0.00000000 " \ " 145  0.00000000  0.00000000 -0.00036124 " \ " 149 -0.00102391  0.00000000  0.00000000 " \ " 149  0.00000000 -0.00102391  0.00000000 " \ " 149  0.00000000  0.00000000 -0.00036124 " \ " 153 -0.00102391  0.00000000  0.00000000 " \ " 153  0.00000000 -0.00102391  0.00000000 " \ " 153  0.00000000  0.00000000 -0.00036124 " \ " 157 -0.00102391  0.00000000  0.00000000 " \ " 157  0.00000000 -0.00102391  0.00000000 " \ " 157  0.00000000  0.00000000 -0.00036124 " \ " 161 -0.00102391  0.00000000  0.00000000 " \ " 161  0.00000000 -0.00102391  0.00000000 " \ " 161  0.00000000  0.00000000 -0.00036124 " \ " 165 -0.00102391  0.00000000  0.00000000 " \ " 165  0.00000000 -0.00102391  0.00000000 " \ " 165  0.00000000  0.00000000 -0.00036124 " \ " 169 -0.00102391  0.00000000  0.00000000 " \ " 169  0.00000000 -0.00102391  0.00000000 " \ " 169  0.00000000  0.00000000 -0.00036124 " \ " 173 -0.00102391  0.00000000  0.00000000 " \ " 173  0.00000000 -0.00102391  0.00000000 " \ " 173  0.00000000  0.00000000 -0.00036124 " \ " 177 -0.00102391  0.00000000  0.00000000 " \ " 177  0.00000000 -0.00102391  0.00000000 " \ " 177  0.00000000  0.00000000 -0.00036124 " \ " 181 -0.00102391  0.00000000  0.00000000 " \ " 181  0.00000000 -0.00102391  0.00000000 " \ " 181  0.00000000  0.00000000 -0.00036124 " \ " 185 -0.00102391  0.00000000  0.00000000 " \ " 185  0.00000000 -0.00102391  0.00000000 " \ " 185  0.00000000  0.00000000 -0.00036124 " \ " 189 -0.00102391  0.00000000  0.00000000 " \ " 189  0.00000000 -0.00102391  0.00000000 " \ " 189  0.00000000  0.00000000 -0.00036124 " \ " 193 -0.00102391  0.00000000  0.00000000 " \ " 193  0.00000000 -0.00102391  0.00000000 " \ " 193  0.00000000  0.00000000 -0.00036124 " \ " 197 -0.00102391  0.00000000  0.00000000 " \ " 197  0.00000000 -0.00102391  0.00000000 " \ " 197  0.00000000  0.00000000 -0.00036124 " \ " 201 -0.00102391  0.00000000  0.00000000 " \ " 201  0.00000000 -0.00102391  0.00000000 " \ " 201  0.00000000  0.00000000 -0.00036124 " \ " 205 -0.00102391  0.00000000  0.00000000 " \ " 205  0.00000000 -0.00102391  0.00000000 " \ " 205  0.00000000  0.00000000 -0.00036124 " \ " 209 -0.00102391  0.00000000  0.00000000 " \ " 209  0.00000000 -0.00102391  0.00000000 " \ " 209  0.00000000  0.00000000 -0.00036124 " \ " 213 -0.00102391  0.00000000  0.00000000 " \ " 213  0.00000000 -0.00102391  0.00000000 " \ " 213  0.00000000  0.00000000 -0.00036124 " 
do

awk '
/SUBSIT/  { npos = $2 ; 
            x=$3; y=$4 ; z=$5; }
!/SUBSIT/ { line=line+1 
  if (line-7 == npos) {
    printf "%12.9f %12.9f %12.9f\n", $1+x, $2+y, $3+z
  } 
  else if (line > 7) {
    printf "%12.9f %12.9f %12.9f\n", $1, $2, $3
  } 
  else 
    print 
} ' >POSCAR.phon <<!
SUBSIT $i
`cat SPOSCAR`
!


sed -i '5s/$/\n'"$header"'/' POSCAR.phon

python run-phon.py  $i
rm -f POSCAR.phon

done


Ndisp=`wc -l DISP | awk '{print $1}'`
sed -i "1s/^/$Ndisp\n/" FORCES
